<!DOCTYPE HTML>
<html lang="ja">
<head>
    <title>My Page | STICKER ARCHIVE</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link rel="stylesheet" href="assets/css/main.css">
    <style>
        /* ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®šï¼ˆå¤‰æ›´ãªã—ï¼‰ */
        body { background: #f0f0f0; color: #181b5a; font-family: sans-serif; overflow-y: auto; min-height: 100vh; }
        .container { padding: 40px 20px; max-width: 1000px; margin: auto; padding-bottom: 100px; }
        h1, h2, p { color: #181b5a !important; }
        .user-info-bar { background: rgba(24, 27, 90, 0.05); padding: 20px; border-radius: 10px; margin-bottom: 30px; border: 1px solid rgba(24, 27, 90, 0.1); }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; margin-top: 20px; }
        .card { background: white; padding: 15px; border-radius: 10px; text-align: center; border: 1px solid rgba(24, 27, 90, 0.2); box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .card:hover { transform: translateY(-3px); }
        .card img { max-width: 100%; height: 150px; object-fit: contain; border-radius: 5px; background: #f9f9f9; margin-bottom: 10px; }
        .btn-group { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        .btn-edit { background: #181b5a; color: white; text-decoration: none; padding: 8px; border-radius: 5px; font-size: 0.9rem; font-weight: bold; }
        .btn-item-delete { background: #fefefe; color: #ff3333; border: 1px solid #ff3333; padding: 6px; border-radius: 5px; font-size: 0.8rem; cursor: pointer; transition: 0.3s; }
        .btn-item-delete:hover { background: #ff3333; color: white; }
        .nav-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
        .btn-archive { background: #5a181b !important; color: white !important; }
        .danger-zone { margin-top: 80px; padding: 20px; border: 2px dashed #ff3333; border-radius: 10px; background: rgba(255,0,0,0.02); }
        .btn-delete-all { background: #ff3333; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>My Archive</h1>
        
        <div class="user-info-bar">
            <p style="margin: 0;">ã“ã‚“ã«ã¡ã¯ã€<span id="userName" style="font-weight: bold; font-size: 1.2rem;">ç¢ºèªä¸­...</span> ã•ã‚“</p>
            <div class="nav-buttons">
                <a href="index.html" class="button">ãƒ›ãƒ¼ãƒ </a>
                <a href="create3.html" class="button primary">ï¼‹ æ–°è¦ä½œæˆ</a>
                <a href="post_archive.html" class="button btn-archive">ğŸ“¦ æŠ•ç¨¿ã®ç®¡ç†ãƒ»å‰Šé™¤</a>
                <button id="logoutBtn" class="button">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>

        <h2>ä¿å­˜æ¸ˆã¿ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ <small style="font-size: 0.9rem; font-weight: normal; opacity: 0.7;">(éå…¬é–‹ãƒ»å†ç·¨é›†ç”¨)</small></h2>
        <hr />

        <div id="projectList" class="grid"></div>

        <div class="danger-zone">
            <h2>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å‰Šé™¤</h2>
            <p>Firebaseã®èªè¨¼æƒ…å ±ã€ãŠã‚ˆã³ä¿å­˜ãƒ»æŠ•ç¨¿ã—ãŸå…¨ã¦ã®ä½œå“ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
            <button id="deleteAccountBtn" class="btn-delete-all">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å®Œå…¨ã«å‰Šé™¤ã™ã‚‹</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, deleteUser, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // â˜… Firebase è¨­å®šã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
        const firebaseConfig = {
            apiKey: "AIzaSyB8KXY15FWlENk7aohJM9D3-ZRkGqAhv7g",
            authDomain: "sticker-archive.firebaseapp.com",
            projectId: "sticker-archive",
            storageBucket: "sticker-archive.firebasestorage.app",
            messagingSenderId: "868816157027",
            appId: "1:868816157027:web:900f1deff73e823251bb56"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        let currentUserName = "";
        let currentUserEmail = "";

        // --- ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ç›£è¦–ï¼ˆé‡è¦ï¼šè¿½ã„è¿”ã•ã‚Œãªã„ãŸã‚ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼‰ ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // ãƒ¡ãƒ¼ãƒ«èªè¨¼ãŒæ¸ˆã‚“ã§ã„ã‚‹ã‹ç¢ºèª
                if (user.emailVerified) {
                    currentUserName = user.displayName || "åç„¡ã—ã•ã‚“";
                    currentUserEmail = user.email;
                    document.getElementById("userName").textContent = currentUserName;
                    
                    // ä½œå“ä¸€è¦§ã‚’è¡¨ç¤º
                    renderProjects(currentUserEmail);
                } else {
                    // èªè¨¼ã•ã‚Œã¦ã„ãªã„å ´åˆã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸
                    alert("ãƒ¡ãƒ¼ãƒ«èªè¨¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚");
                    window.location.href = "login.html";
                }
            } else {
                // å®Œå…¨ã«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ã§ã‚ã‚‹ã¨ç¢ºå®šã—ã¦ã‹ã‚‰ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                window.location.href = "login.html";
            }
        });

        // --- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç† ---
        document.getElementById("logoutBtn").addEventListener("click", () => {
            if(confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
                signOut(auth).then(() => {
                    localStorage.removeItem("currentUser");
                    localStorage.removeItem("currentUserEmail");
                    localStorage.removeItem("isAdmin");
                    window.location.href = "login.html";
                });
            }
        });

        // --- ä½œå“ã‚’è¡¨ç¤ºã™ã‚‹ãƒ¡ã‚¤ãƒ³å‡¦ç† ---
        // --- ä½œå“ã‚’è¡¨ç¤ºã™ã‚‹ãƒ¡ã‚¤ãƒ³å‡¦ç† ---
        // mypage.html ã® renderProjects é–¢æ•°
        function renderProjects(userEmail) {
            console.log("æ¤œç´¢ä¸­ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:", userEmail); // ãƒ‡ãƒãƒƒã‚°ç”¨
            const projectList = document.getElementById("projectList");
            projectList.innerHTML = ""; 
            
            const allProjects = JSON.parse(localStorage.getItem("projects")) || [];
            console.log("å…¨ãƒ‡ãƒ¼ã‚¿æ•°:", allProjects.length);

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°åˆ¤å®š
            const myProjects = allProjects
                .map((p, index) => ({ ...p, originalIndex: index }))
                .filter(p => {
                    // ownerId ãŒä¸€è‡´ã™ã‚‹ã‹ã€å¤ã„ãƒ‡ãƒ¼ã‚¿æ•‘æ¸ˆã®ãŸã‚ owner ãŒä¸€è‡´ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    return p.ownerId === userEmail;
                });

            if (myProjects.length === 0) {
                projectList.innerHTML = `<div style="grid-column: 1/-1; padding: 40px; text-align: center; color: #888;">
                    ä¿å­˜ã•ã‚ŒãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚<br>
                    <small>(Email: ${userEmail})</small>
                </div>`;
                return;
            }

            myProjects.forEach((project) => {
                const card = document.createElement("div");
                card.className = "card";
                card.innerHTML = `
                    <img src="${project.imageData}">
                    <p style="margin: 0; font-weight: bold;">${project.title || 'ç„¡é¡Œ'}</p>
                    <div class="btn-group">
                        <a href="create3.html?id=${project.originalIndex}" class="btn-edit">å†ç·¨é›†</a>
                        <button onclick="window.deleteProject(${project.originalIndex})" class="btn-item-delete">å‰Šé™¤</button>
                    </div>
                `;
                projectList.appendChild(card);
            });
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«é–¢æ•°ã‚’å…¬é–‹
        window.deleteProject = function(index) {
            if (confirm("ã“ã®ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) {
                let allProjects = JSON.parse(localStorage.getItem("projects")) || [];
                allProjects.splice(index, 1);
                localStorage.setItem("projects", JSON.stringify(allProjects));
                renderProjects(currentUserEmail);
            }
        };

        // --- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ï¼ˆFirebaseé€£æºï¼‰ ---
        document.getElementById("deleteAccountBtn").addEventListener("click", async () => {
            const user = auth.currentUser;
            if (!user) return;

            const confirmMsg = "ã€æœ€çµ‚ç¢ºèªã€‘\næœ¬å½“ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nä¿å­˜ãƒ»æŠ•ç¨¿ã—ãŸå…¨ã¦ã®ä½œå“ãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨ã«æ¶ˆå»ã•ã‚Œã¾ã™ã€‚";
            if (confirm(confirmMsg)) {
                try {
                    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™å¯¾ç­–ï¼šå‰Šé™¤å‰ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†å…¥åŠ›ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ãŒã€
                    // ã¾ãšã¯ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ
                    
                    // 1. ãƒ­ãƒ¼ã‚«ãƒ«ã®ä½œå“ãƒ‡ãƒ¼ã‚¿ï¼ˆprojectsï¼‰ã‚’å‰Šé™¤
                    let allProjects = JSON.parse(localStorage.getItem("projects")) || [];
                    const remainingProjects = allProjects.filter(p => p.owner !== currentUserEmail);
                    localStorage.setItem("projects", JSON.stringify(remainingProjects));

                    // 2. ã‚®ãƒ£ãƒ©ãƒªãƒ¼æŠ•ç¨¿ï¼ˆgalleryï¼‰ã‚’å‰Šé™¤
                    let gallery = JSON.parse(localStorage.getItem("gallery")) || [];
                    const remainingGallery = gallery.filter(post => post.author !== currentUserEmail);
                    localStorage.setItem("gallery", JSON.stringify(remainingGallery));

                    // 3. Firebaseã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤
                    await deleteUser(user);

                    localStorage.clear();
                    alert("ã™ã¹ã¦ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»ã—ã¾ã—ãŸã€‚ã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚");
                    window.location.href = "login.html";

                } catch (error) {
                    console.error(error);
                    if (error.code === "auth/requires-recent-login") {
                        alert("ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã«ã¯å†ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚ä¸€åº¦ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¦ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã€ã™ãã«å‰Šé™¤ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚");
                    } else {
                        alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message);
                    }
                }
            }
        });
    </script>
</body>
</html>